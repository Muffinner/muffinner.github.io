<!DOCTYPE html>
<html>
<head>
    <title>Catch the Dot!</title>
    <style>
        body {
            font-family: sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            background-color: #f0f0f0;
        }

        #game-container {
            position: relative;
            width: 400px;
            height: 300px;
            border: 2px solid black;
            background-color: white;
        }

        .player {
            position: absolute;
            width: 20px;
            height: 20px;
            background-color: blue; /* Default color */
            border-radius: 50%; /* Make it a circle */
        }
        #player1{
          background-color: blue;
        }

        #player2{
            background-color: red;
        }

        #dot {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: green;
            border-radius: 50%;
        }

        #score {
            margin-top: 20px;
            font-size: 18px;
        }

        #message{
            color:red;
        }
    </style>
</head>
<body>
    <div id="game-container">
        <div id="player1" class="player"></div>
        <div id="player2" class="player"></div>
        <div id="dot"></div>
    </div>
    <div id="score">
        Player 1: <span id="score1">0</span> | Player 2: <span id="score2">0</span>
    </div>
    <div id="message"></div>

    <!-- Firebase App (the core Firebase SDK) -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <!-- Firebase Realtime Database -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

    <script>
        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY", // REPLACE WITH YOUR KEYS
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com", // REPLACE
            projectId: "YOUR_PROJECT_ID", // REPLACE
            storageBucket: "YOUR_PROJECT_ID.appspot.com", // REPLACE
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID", // REPLACE
            appId: "YOUR_APP_ID", // REPLACE
            databaseURL: "https://YOUR_PROJECT_ID-default-rtdb.firebaseio.com" // REPLACE
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // --- Game Variables ---
        const gameContainer = document.getElementById('game-container');
        const player1 = document.getElementById('player1');
        const player2 = document.getElementById('player2');
        const dot = document.getElementById('dot');
        const score1Display = document.getElementById('score1');
        const score2Display = document.getElementById('score2');
        const messageDisplay = document.getElementById('message');

        let player1Pos = { x: 50, y: 50 };
        let player2Pos = { x: 350, y: 250 };
        let dotPos = { x: 200, y: 150 };
        let score1 = 0;
        let score2 = 0;
        let myPlayerId = null; // 'player1' or 'player2'

        // --- Firebase References ---
        const gameRef = database.ref('game');
        const player1Ref = gameRef.child('player1');
        const player2Ref = gameRef.child('player2');
        const dotRef = gameRef.child('dot');
        const scoreRef = gameRef.child('score');


        // --- Player Assignment ---
        gameRef.child('players').transaction(players => {
            if (!players) {
                players = { player1: true, player2: false }; // player1 joins first
                myPlayerId = 'player1';
            } else if (!players.player1) {
                players.player1 = true;
                myPlayerId = 'player1';
            } else if (!players.player2) {
                players.player2 = true;
                myPlayerId = 'player2';
            } else {
                // Game is full
                messageDisplay.textContent = 'Game is full!';
                return; // Don't update the transaction
            }
            return players;
        }, (error, committed) => {
            if (error) {
                console.error("Player assignment failed:", error);
            } else if (committed) {
                console.log("I am:", myPlayerId);
                setupGame(); // Start game setup after player assignment
            }
        });

        function setupGame() {
            // --- Initial Setup and Event Listeners ---

            // Update initial positions in Firebase (only if you're player 1)
            if (myPlayerId === 'player1') {
                player1Ref.set(player1Pos);
                player2Ref.set(player2Pos);
                dotRef.set(dotPos);
                scoreRef.set({ player1: 0, player2: 0 });
            }

            // Listen for changes from other players
            player1Ref.on('value', snapshot => {
                if (myPlayerId !== 'player1') { // Only update if it's the *other* player
                    player1Pos = snapshot.val();
                    updatePlayerPosition(player1, player1Pos);
                }
            });
            player2Ref.on('value', snapshot => {
                if (myPlayerId !== 'player2') {
                    player2Pos = snapshot.val();
                    updatePlayerPosition(player2, player2Pos);
                }
            });

            dotRef.on('value', snapshot => {
                dotPos = snapshot.val();
                updateDotPosition();
            });

            scoreRef.on('value', snapshot => {
                const scores = snapshot.val();
                score1 = scores.player1;
                score2 = scores.player2;
                updateScoreDisplay();
            });

            // --- Player Movement (Client-Side) ---
            document.addEventListener('keydown', (event) => {
                let myPos, myRef;
                if (myPlayerId === 'player1') {
                    myPos = player1Pos;
                    myRef = player1Ref;
                } else if (myPlayerId === 'player2') {
                    myPos = player2Pos;
                    myRef = player2Ref;
                } else {
                    return; // Not a valid player
                }

                const speed = 5;
                switch (event.key) {
                    case 'ArrowUp':    myPos.y -= speed; break;
                    case 'ArrowDown':  myPos.y += speed; break;
                    case 'ArrowLeft':  myPos.x -= speed; break;
                    case 'ArrowRight': myPos.x += speed; break;
                    default: return; // Ignore other keys
                }

                // Keep player within bounds
                myPos.x = Math.max(0, Math.min(myPos.x, gameContainer.offsetWidth - player1.offsetWidth));
                myPos.y = Math.max(0, Math.min(myPos.y, gameContainer.offsetHeight - player1.offsetHeight));

                // Update local position and Firebase
                updatePlayerPosition(myPlayerId === 'player1' ? player1 : player2, myPos);
                myRef.set(myPos);

                // Check for collision (after moving)
                checkCollision();
            });


            // --- Helper Functions ---
            function updatePlayerPosition(player, pos) {
                player.style.left = pos.x + 'px';
                player.style.top = pos.y + 'px';
            }

            function updateDotPosition() {
                dot.style.left = dotPos.x + 'px';
                dot.style.top = dotPos.y + 'px';
            }

            function updateScoreDisplay() {
                score1Display.textContent = score1;
                score2Display.textContent = score2;
            }

            function checkCollision() {
              const playerRect = (myPlayerId === 'player1' ? player1 : player2).getBoundingClientRect();
              const dotRect = dot.getBoundingClientRect();

              if (
                  playerRect.left < dotRect.right &&
                  playerRect.right > dotRect.left &&
                  playerRect.top < dotRect.bottom &&
                  playerRect.bottom > dotRect.top
              ) {
                  // Collision!
                  if (myPlayerId === 'player1') {
                      score1++;
                  } else {
                      score2++;
                  }
                  scoreRef.set({ player1: score1, player2: score2 }); // Update Firebase
                  moveDot(); // Move the dot (only one player does this)
              }
            }

            function moveDot() {
              if (myPlayerId === 'player1'){ // Only player 1 moves the dot
                dotPos.x = Math.floor(Math.random() * (gameContainer.offsetWidth - dot.offsetWidth));
                dotPos.y = Math.floor(Math.random() * (gameContainer.offsetHeight - dot.offsetHeight));
                dotRef.set(dotPos);  // Update Firebase
              }
            }

            // Initial position updates
            updatePlayerPosition(player1, player1Pos);
            updatePlayerPosition(player2, player2Pos);
            updateDotPosition();
            updateScoreDisplay();
        }


        // --- Cleanup (Important for disconnecting) ---

        window.addEventListener('beforeunload', () => {
            if (myPlayerId) {
                gameRef.child('players').child(myPlayerId).set(false); // Mark player as disconnected
                // Turn off listeners
                player1Ref.off();
                player2Ref.off();
                dotRef.off();
                scoreRef.off();
            }
        });
    </script>
</body>
</html>