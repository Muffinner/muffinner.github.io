<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Networked Circle Game</title>
    <style>
        body {
            margin: 0;
            overflow: hidden; /* Prevent scrollbars */
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: #222;
        }
        #gameCanvas {
            background-color: #333;
            border: 1px solid #555;
        }
        #message {
          position: absolute;
          top: 10px;
          left: 10px;
          color: white;
          font-family: sans-serif;
        }
    </style>
</head>
<body>
    <canvas id="gameCanvas" width="800" height="600"></canvas>
    <div id="message"></div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const messageDiv = document.getElementById('message');

        const playerRadius = 20;
        let playerId = null;
        const players = {};  // Store player data { id: { x, y, color } }


        // --- WebSocket Connection ---
        const ws = new WebSocket('ws://localhost:8765');  //  REPLACE THIS with server address if not local!

        ws.onopen = () => {
            console.log('WebSocket connected');
            messageDiv.textContent = 'Connected to server.';
        };

        ws.onmessage = (event) => {
            const data = JSON.parse(event.data);

            if (data.type === 'welcome') {
                playerId = data.id;
                console.log("My player ID:", playerId);
                messageDiv.textContent = `Connected. Your ID: ${playerId}`;
            } else if (data.type === 'state') {
                // Update all player positions
                for (const id in data.players) {
                    players[id] = data.players[id];
                }
            } else if (data.type === 'player_joined') {
                players[data.id] = { x: data.x, y: data.y, color: data.color };
            } else if (data.type === 'player_left') {
                delete players[data.id];
            } else if (data.type === 'player_moved') {
                if (players[data.id]) { // Check if player still exists (important!)
                   players[data.id].x = data.x;
                   players[data.id].y = data.y;
                }
            }
        };

        ws.onclose = () => {
            console.log('WebSocket disconnected');
            messageDiv.textContent = 'Disconnected from server.';
            //  Optional:  Attempt to reconnect (with backoff).
        };

        ws.onerror = (error) => {
            console.error('WebSocket error:', error);
            messageDiv.textContent = 'WebSocket Error.  Check console.';
        };


        // --- Game Logic ---

        function drawPlayer(player) {
            ctx.beginPath();
            ctx.arc(player.x, player.y, playerRadius, 0, 2 * Math.PI);
            ctx.fillStyle = player.color;
            ctx.fill();
            ctx.closePath();
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            for (const id in players) {
                drawPlayer(players[id]);
            }

            requestAnimationFrame(draw);
        }



        // --- Input Handling ---
        const keys = {};

        window.addEventListener('keydown', (event) => {
            keys[event.key] = true;
          
            sendMovement();
        });

        window.addEventListener('keyup', (event) => {
            keys[event.key] = false;
        });


        // --- Movement and Sending Updates ---
        const moveSpeed = 3;

        function sendMovement() {
            if (!ws || ws.readyState !== WebSocket.OPEN || !playerId) {
              return;
            }
            let dx = 0;
            let dy = 0;

            if (keys['ArrowLeft'] || keys['a']) dx -= moveSpeed;
            if (keys['ArrowRight'] || keys['d']) dx += moveSpeed;
            if (keys['ArrowUp'] || keys['w']) dy -= moveSpeed;
            if (keys['ArrowDown'] || keys['s']) dy += moveSpeed;

             if (dx !== 0 || dy !== 0) {
              ws.send(JSON.stringify({ type: 'move', dx: dx, dy: dy }));
            }
        }
        
        // Start the game loop
        draw();

    </script>
</body>
</html>